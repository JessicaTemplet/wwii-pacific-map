<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Righteous Might: Victory over Japan in WWII</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- PapaParse (robust CSV parsing) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{--map-height:72vh;--timeline-height:24vh}
    body{margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:#f8f9fa;color:#111}
    header{padding:12px 16px;text-align:center}
    header h1{margin:0;font-size:20px}
    #timelineWrap{width:94%;max-width:1100px;margin:10px auto;height:var(--timeline-height)}
    #timeline{width:100%;height:100%}
    #map{width:100%;height:var(--map-height);box-shadow:0 2px 10px rgba(0,0,0,0.06)}
    
    /* Fixed legend positioning - bottom right with better visibility */
    .legend{
      position: absolute !important;
      bottom: 20px !important;
      right: 20px !important;
      background: rgba(255,255,255,0.95) !important;
      padding: 12px !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
      font-size: 12px !important;
      line-height: 1.4 !important;
      max-width: 220px !important;
      z-index: 1000 !important;
      border: 1px solid rgba(0,0,0,0.1) !important;
    }
    .legend-title{font-weight:bold;margin-bottom:8px;color:#333;font-size:13px}
    .legend-row{display:flex;align-items:center;margin-bottom:5px}
    .legend-swatch{width:16px;height:12px;margin-right:8px;border-radius:3px;border:1px solid rgba(0,0,0,0.2);flex-shrink:0}
    .legend-symbol{width:16px;height:16px;margin-right:8px;display:inline-block;vertical-align:middle;flex-shrink:0}
    .legend-text{font-size:11px;color:#333}
    .legend-section{margin-bottom:8px}
    .legend-section-title{font-weight:bold;font-size:11px;color:#555;margin-bottom:3px}
    
    /* event count badge */
    #countBadge{position:fixed;right:14px;top:14px;background:#1F6FEB;color:#fff;padding:6px 10px;border-radius:999px;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,0.12);z-index:9999}
    a.source{color:#1F6FEB;text-decoration:none}
    
    /* Custom marker styles for numbered circles */
    .numbered-marker {
      background: #1F6FEB;
      border: 2px solid #fff;
      border-radius: 50%;
      color: #fff;
      font-weight: bold;
      text-align: center;
      font-size: 10px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .numbered-marker.japan { background: #D0021B; }
    .numbered-marker.joint { background: #7A3EE6; }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .legend { 
        max-width: 180px !important; 
        font-size: 11px !important;
        bottom: 10px !important;
        right: 10px !important;
      }
      .legend-text { font-size: 10px; }
      .numbered-marker { font-size: 9px; }
      header h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Righteous Might: Victory over Japan in World War II</h1>
  </header>

  <div id="timelineWrap">
    <canvas id="timeline"></canvas>
  </div>

  <div id="map" aria-label="WWII Pacific map"></div>

  <div id="countBadge" aria-live="polite">Events: ‚Äî</div>

<script>
/* ---------- Helper utilities ---------- */
function toFloat(v){ 
  if (v == null) return null;
  const cleaned = v.toString().trim().replace(/^"|"$/g,''); 
  const n = parseFloat(cleaned); 
  return isNaN(n) ? null : n; 
}
function stripQuotes(s){ return (s||'').toString().replace(/^"|"$/g,'').trim(); }

/* ---------- Config: fallback icons (public domain/SVG) ---------- */
const ICON_URLS = {
  bomb: 'https://upload.wikimedia.org/wikipedia/commons/8/8a/Font_Awesome_5_solid_bomb.svg',
  atomic: 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Noun_project_nuclear-explosion_icon.svg',
  flag: 'https://upload.wikimedia.org/wikipedia/en/a/a4/Flag_of_the_United_States.svg'
};

/* Preload an image and resolve true/false for availability */
function preloadImage(url) {
  return new Promise((resolve) => {
    if(!url) return resolve(false);
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    try { img.crossOrigin = 'anonymous'; } catch(e){}
    img.src = url;
    setTimeout(()=>resolve(!!img.complete && img.naturalWidth > 0), 3000);
  });
}

function makeLicon(url, size=26){
  return L.icon({ iconUrl: url, iconSize:[size,size], iconAnchor:[size/2,size/2], popupAnchor:[0,-size/2] });
}

function createNumberedIcon(number, side = 'USA') {
  let markerClass = '';
  if (side.toLowerCase() === 'japan') markerClass = 'japan';
  else if (side.toLowerCase() === 'joint') markerClass = 'joint';
  
  return L.divIcon({
    html: `<div class="numbered-marker ${markerClass}" style="width: 26px; height: 26px;">${number}</div>`,
    className: 'custom-div-icon',
    iconSize: [26, 26],
    iconAnchor: [13, 13],
    popupAnchor: [0, -13]
  });
}

/* ---------- Load timeline.csv ---------- */
async function loadAndRenderTimeline(){
  try{
    const txt = await (await fetch('timeline.csv')).text();
    const res = Papa.parse(txt, { header:true, skipEmptyLines:true });
    const rows = res.data;

    const labels = rows.map(r=>stripQuotes(r.Year));
    const us = rows.map(r => +r['US Total Personnel'] || 0);
    const jp = rows.map(r => +r['Japan Total Personnel'] || 0);
    const notes = rows.map(r => stripQuotes(r.Notes || ''));

    const ctx = document.getElementById('timeline').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label:'US Personnel', data: us, backgroundColor: '#1F6FEB' },
          { label:'Japan Personnel', data: jp, backgroundColor: '#D0021B' }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'Pacific Theater Military Personnel by Year', font: { size: 14 } },
          tooltip: {
            callbacks: {
              afterBody: function(items){
                const i = items[0].dataIndex || 0;
                return notes[i] ? ('Notes: ' + notes[i]) : '';
              }
            }
          },
          legend: { position: 'top', labels: { usePointStyle: true } }
        },
        scales: { x: { beginAtZero: true } }
      }
    });
  } catch(e) {
    console.error('Timeline error', e);
  }
}

/* ---------- Load points.csv and paths.geojson ---------- */
async function loadAndRenderMap(){
  const map = L.map('map', { preferCanvas:true }).setView([18,145], 3);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div class="legend-title">WWII Pacific Theater</div>
      <div class="legend-section">
        <div class="legend-section-title">Forces</div>
        <div class="legend-row"><span class="legend-swatch" style="background:#D0021B"></span><span class="legend-text">Japanese offensive</span></div>
        <div class="legend-row"><span class="legend-swatch" style="background:#1F6FEB"></span><span class="legend-text">US/Allied offensive</span></div>
        <div class="legend-row"><span class="legend-swatch" style="background:#7A3EE6"></span><span class="legend-text">Joint operations</span></div>
      </div>
      <div class="legend-section">
        <div class="legend-section-title">Special Events</div>
        <div class="legend-row"><span class="legend-swatch" style="background:#FF6B35">üí£</span><span class="legend-text">Major bombing</span></div>
        <div class="legend-row"><span class="legend-swatch" style="background:#FF0000">‚ò¢Ô∏è</span><span class="legend-text">Atomic weapons</span></div>
        <div class="legend-row"><span class="legend-swatch" style="background:#00AA00">üè≥Ô∏è</span><span class="legend-text">Surrender/Flag raising</span></div>
      </div>
      <div style="font-size:10px;color:#666;margin-top:8px;">Numbers indicate chronological order</div>
    `;
    return div;
  };
  legend.addTo(map);

  const [pointsTxt, pathsJson] = await Promise.all([
    fetch('points.csv').then(r=>r.text()),
    fetch('paths.geojson').then(r=>r.json()).catch(()=>null)
  ]);

  const parsed = Papa.parse(pointsTxt, { header:true, skipEmptyLines:true, dynamicTyping:true });
  const rows = parsed.data || [];

  const markerLayer = L.featureGroup();
  let validMarkers = 0, skippedMarkers = 0;
  
  rows.forEach((r, idx) => {
    const lat = toFloat(r.lat || r.Lat || r.Latitude);
    const lon = toFloat(r.lon || r.Lon || r.Longitude);
    if(lat===null || lon===null || lat < -90 || lat > 90 || lon < -180 || lon > 180){
      skippedMarkers++;
      return;
    }
    const name = stripQuotes(r.name || r.Name || '');
    const label = stripQuotes(r.label || name);
    const sideOffensive = stripQuotes(r.side_offensive || 'USA');
    const rawSymbol = stripQuotes(r.marker_symbol || '');
    
    let marker = null;
    if(rawSymbol && rawSymbol.toLowerCase().startsWith('http')) {
      marker = L.marker([lat,lon], { icon: makeLicon(rawSymbol,28) });
    }
    if(!marker){
      marker = L.marker([lat,lon], { icon: createNumberedIcon(idx+1, sideOffensive) });
    }
    marker.addTo(markerLayer).bindPopup(`<strong>${label}</strong>`);
    validMarkers++;
  });

  markerLayer.addTo(map);
  if(markerLayer.getLayers().length > 0){ map.fitBounds(markerLayer.getBounds().pad(0.05)); }
  document.getElementById('countBadge').textContent = `Events: ${validMarkers}${skippedMarkers>0?` (${skippedMarkers} skipped)`:''}`;
}

(async function(){
  await loadAndRenderTimeline();
  await loadAndRenderMap();
})();
</script>
</body>
  </html>
