<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Righteous Might: Victory over Japan in World War II</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    .legend { background:#fff; padding:8px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.3); font-size:13px; }
    .credit { background:#fff; padding:6px 8px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.18); font-size:13px; margin-top:8px; display:flex; align-items:center; gap:8px;}
    .marker-label { font-weight:700; font-size:12px; }
    .triangle { width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:10px solid; transform-origin:center; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // CONFIG
  const POINTS_CSV = 'points.csv';
  const PATHS_GEOJSON = 'paths.geojson';

  // Icons (from your spec)
  const ICONS = {
    bomb: 'https://upload.wikimedia.org/wikipedia/commons/8/8a/Font_Awesome_5_solid_bomb.svg',
    atomic: 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Noun_project_nuclear-explosion_icon.svg',
    usflag: 'https://upload.wikimedia.org/wikipedia/en/a/a4/Flag_of_the_United_States.svg'
  };

  // Create map centered on Pacific, prevent tile wrapping
  const map = L.map('map', {
    center: [5, -160],
    zoom: 3,
    minZoom: 2,
    worldCopyJump: false
  });

  // Free tiles (OpenStreetMap) with noWrap to avoid horizontal tile wrap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    noWrap: true,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Utility: parse CSV (simple)
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split(',').map(h => h.trim());
    return lines.map(line => {
      // naive CSV parse assuming no internal commas in fields (our CSV is safe)
      const cols = line.split(',').map(c => c.trim());
      const obj = {};
      headers.forEach((h,i) => obj[h] = cols[i] || '');
      return obj;
    });
  }

  // Create triangle DivIcon for arrowheads
  function createTriangleIcon(color, rotation=0) {
    const el = document.createElement('div');
    el.className = 'triangle';
    el.style.borderBottomColor = color;
    el.style.transform = 'rotate(' + rotation + 'deg)';
    return L.divIcon({
      html: el.outerHTML,
      className: '',
      iconSize: [12,12],
      iconAnchor: [6,6]
    });
  }

  // Function to add markers from CSV data
  function addPointMarker(row) {
    const lat = parseFloat(row.lat);
    const lon = parseFloat(row.lon);
    if (isNaN(lat) || isNaN(lon)) return;

    const color = (row.marker_color || '#000000').replace(/\s/g,'');
    const sym = (row.marker_symbol || 'circle').trim();

    // marker creation logic
    if (sym === 'circle') {
      const circle = L.circleMarker([lat, lon], {
        radius: 8,
        color: '#000',
        fillColor: color,
        weight: 1,
        fillOpacity: 1
      }).addTo(map);

      circle.bindPopup('<div class="marker-label">' + row.label + '</div><div style="font-size:12px;">' + row.short_desc + '</div><div style="margin-top:6px;"><a href="' + row.source_url + '" target="_blank">Source</a></div>');
    } else if (sym === ICONS.bomb || sym === ICONS.atomic || sym === ICONS.usflag || sym.startsWith('http')) {
      // Use remote SVG icon as icon
      const icon = L.icon({
        iconUrl: sym,
        iconSize: [22,22],
        iconAnchor: [11,11],
        popupAnchor: [0,-11]
      });
      L.marker([lat, lon], {icon}).addTo(map).bindPopup('<div class="marker-label">' + row.label + '</div><div style="font-size:12px;">' + row.short_desc + '</div><div style="margin-top:6px;"><a href="' + row.source_url + '" target="_blank">Source</a></div>');
    } else if (sym === 'triangle') {
      // triangle arrowhead (handled by path arrowhead features in geojson)
      const tri = createTriangleIcon(color);
      L.marker([lat, lon], {icon: tri}).addTo(map);
    } else {
      // fallback: use a simple marker with color
      const circle = L.circleMarker([lat, lon], {
        radius: 7,
        color: '#000',
        fillColor: color,
        weight: 1,
        fillOpacity: 1
      }).addTo(map);
      circle.bindPopup('<div class="marker-label">' + row.label + '</div><div style="font-size:12px;">' + row.short_desc + '</div><div style="margin-top:6px;"><a href="' + row.source_url + '" target="_blank">Source</a></div>');
    }
  }

  // Load points CSV
  fetch(POINTS_CSV).then(r=>r.text()).then(text=>{
    const rows = parseCSV(text);
    rows.forEach(r => {
      // If marker_symbol column contains the literal icon URL, use icon URL
      if (r.marker_symbol && r.marker_symbol.startsWith('http')) {
        r.marker_symbol = r.marker_symbol; // left as-is
      } else {
        // normalize certain short names to real URLs
        if (r.marker_symbol === 'bomb' || r.marker_symbol === ICONS.bomb) r.marker_symbol = ICONS.bomb;
        if (r.marker_symbol === 'atomic' || r.marker_symbol === ICONS.atomic) r.marker_symbol = ICONS.atomic;
        if (r.marker_symbol === 'usflag' || r.marker_symbol === ICONS.usflag) r.marker_symbol = ICONS.usflag;
      }
      addPointMarker(r);
    });
  }).catch(err=>console.error('Error loading points.csv', err));

  // Load paths geojson and add lines + arrowheads
  fetch(PATHS_GEOJSON).then(r=>r.json()).then(json=>{
    const geo = json;
    geo.features.forEach(f=>{
      if (!f.geometry) return;
      if (f.geometry.type === 'LineString') {
        const coords = f.geometry.coordinates.map(c => [c[1], c[0]]); // GeoJSON is [lon,lat]
        const style = (f.properties && f.properties.style) ? f.properties.style : {stroke:'#000', 'stroke-width':2, 'stroke-dasharray':'6,4'};
        const poly = L.polyline(coords, {
          color: style.stroke,
          weight: style['stroke-width'],
          dashArray: style['stroke-dasharray']
        }).addTo(map);
      } else if (f.geometry.type === 'Point') {
        const c = f.geometry.coordinates;
        const latlng = [c[1], c[0]];
        const marker_symbol = f.properties && f.properties.marker_symbol;
        const marker_color = f.properties && f.properties.marker_color ? f.properties.marker_color : '#000';
        if (marker_symbol === 'triangle') {
          // try to compute approximate rotation if properties.path_end exists (optional)
          const icon = createTriangleIcon(marker_color, 0);
          L.marker(latlng, {icon}).addTo(map);
        } else {
          // fallback to small circle
          L.circleMarker(latlng, {radius:5, fillColor:marker_color, color:'#000', weight:1, fillOpacity:1}).addTo(map);
        }
      }
    });
  }).catch(err=>console.error('Error loading paths.geojson', err));

  // Legend & credit (bottom-left)
  const legend = L.control({position:'bottomleft'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = '<div style="font-weight:700;margin-bottom:6px">Legend</div>' +
      '<div><span style="display:inline-block;width:14px;height:14px;background:#2E7D32;margin-right:6px;border-radius:2px;"></span>US Army</div>' +
      '<div><span style="display:inline-block;width:14px;height:14px;background:#1F6FEB;margin-right:6px;border-radius:2px;"></span>US Navy</div>' +
      '<div><span style="display:inline-block;width:14px;height:14px;background:#111111;margin-right:6px;border-radius:2px;"></span>US Marines</div>' +
      '<div><span style="display:inline-block;width:14px;height:14px;background:#D0021B;margin-right:6px;border-radius:2px;"></span>Imperial Japan</div>' +
      '<div style="margin-top:6px;"><img src="'+ICONS.bomb+'" width="14" style="vertical-align:middle"> = major bombing</div>' +
      '<div style="margin-top:4px;"><img src="'+ICONS.atomic+'" width="14" style="vertical-align:middle"> = atomic</div>' +
      '<div style="margin-top:4px;"><img src="'+ICONS.usflag+'" width="14" style="vertical-align:middle"> = surrender / flag-raising</div>';
    return div;
  };
  legend.addTo(map);

  // Credit box (bottom-left under legend)
  const credit = L.control({position:'bottomleft'});
  credit.onAdd = function(){
    const div = L.DomUtil.create('div','credit');
    div.innerHTML = '<img src="https://www.gravatar.com/avatar/?d=mp&s=24" width="24" height="24" style="border-radius:50%">' +
      '<div>Created by Thug Adams thugadams.substack.com</div>';
    return div;
  };
  credit.addTo(map);

  </script>
</body>
</html>