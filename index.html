<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>WWII Pacific Map Debug Version</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css"/>
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; }
    #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:1000; }
    .topbar { position:absolute; top:0; left:0; right:0; height:70px; background:#0b2545; color:#fff; display:flex; align-items:center; padding:10px 16px; z-index:2000; }
    .timeline { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .year-pill { background:rgba(255,255,255,0.1); padding:6px 10px; border-radius:4px; color:#fff; cursor:pointer; }
    .year-tooltip { position:absolute; top:70px; right:12px; background:#fff; color:#000; padding:8px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.3); font-size:13px; display:none; max-width:300px; z-index:3000; }
    .legend-box, .credits-box { position:absolute; left:12px; bottom:12px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.25); font-size:13px; z-index:2000; }
    .credits-box { bottom:80px; }
    .legend-entry, .swatch { /* as before */ }
    .popup { background:#fff; padding:8px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.25); max-width:300px; font-size:13px; }
    .popup img { width:100%; height:90px; object-fit:cover; border-radius:4px; margin-bottom:6px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar">
    <div class="title">Righteous Might: Victory over Japan in World War II</div>
    <div class="timeline" id="timeline"></div>
  </div>
  <div class="year-tooltip" id="yearTooltip"></div>
  <div class="legend-box" id="legendBox">Legend loading...</div>
  <div class="credits-box">Created by Thug Adams<br/><a href="https://thugadams.substack.com" target="_blank">thugadams.substack.com</a></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    console.log("DEBUG: script started");

    // Base map
    try {
      const map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([150, 5]),
          zoom: 3,
          minZoom:2
        })
      });
      console.log("DEBUG: base map layer initialized");
      
      // Load geojson
      const vectorSource = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: 'events.geojson'
      });
      vectorSource.on('addfeature', function(event) {
        console.log("DEBUG: feature added:", event.feature.getProperties().title);
      });
      vectorSource.on('error', function(e) {
        console.error("DEBUG: error loading features:", e);
      });

      const vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: feature => {
          const mt = (feature.get('marker_type') || '').toLowerCase();
          console.log("DEBUG: styling feature type:", mt);
          let iconUrl;
          switch(mt) {
            case 'japanese_offensive': iconUrl = ICONS.japanese; break;
            case 'us_offensive': iconUrl = ICONS.usa; break;
            case 'joint': iconUrl = ICONS.joint; break;
            case 'bomb': iconUrl = ICONS.bomb; break;
            case 'atomic': iconUrl = ICONS.atomic; break;
            case 'surrender': iconUrl = ICONS.flag; break;
            default: iconUrl = ICONS.default; console.warn("DEBUG: unknown marker_type for feature", feature.get('title'), mt);
          }
          return new ol.style.Style({
            image: new ol.style.Icon({ src: iconUrl, scale:0.9, anchor:[0.5,0.5] })
          });
        }
      });
      map.addLayer(vectorLayer);

      // Popup
      const popupEl = document.createElement('div');
      popupEl.className='popup';
      const overlay = new ol.Overlay({
        element: popupEl,
        autoPan: { animation: { duration:250 } }
      });
      map.addOverlay(overlay);

      map.on('singleclick', evt => {
        const f = map.forEachFeatureAtPixel(evt.pixel, ft => ft);
        if (!f) { overlay.setPosition(undefined); return; }
        const props = f.getProperties();
        const content = `<h3>${props.title}</h3><div style="font-size:12px;color:#666;">${props.start_date}${props.end_date ? ' â€” ' + props.end_date : ''}</div>${props.short_desc ? '<div>' + props.short_desc + '</div>' : ''}${props.source ? '<div style="margin-top:6px;font-size:12px;"><a href="' + props.source + '" target="_blank">Read more</a></div>' : ''}`;
        popupEl.innerHTML = content;
        overlay.setPosition(evt.coordinate);
      });

      console.log("DEBUG: map & vector layer and popup set up");

    } catch (err) {
      console.error("DEBUG: fatal map init error:", err);
    }

    // icons definitions (moved above for clarity)
    function svgDataUrl(svg) { return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }
    const ICONS = {
      japanese: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#D0021B'/></svg>`),
      usa: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#1F6FEB'/></svg>`),
      joint: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#D0021B'/><stop offset='1' stop-color='#1F6FEB'/></linearGradient></defs><circle cx='18' cy='18' r='12' fill='url(#g)'/></svg>`),
      bomb: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect x='8' y='6' rx='2' width='20' height='8' fill='#f0ad4e'/><path d='M16 14 L20 30 L16 28 L12 30 Z' fill='#c77'/></svg>`),
      atomic: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><circle cx='20' cy='20' r='14' fill='#f44336'/><text x='20' y='24' font-size='12' font-weight='700' text-anchor='middle' fill='#fff'>A</text></svg>`),
      flag: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect x='3' y='8' width='20' height='10' rx='2' fill='#b22234'/><rect x='3' y='8' width='10' height='5' fill='#3c3b6e'/></svg>`),
      default: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#cccccc'/></svg>`)
    };

  </script>
</body>
</html>
