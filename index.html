<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Righteous Might: Victory over Japan in WWII</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { margin:0; font-family:sans-serif; }
  #timelineContainer { width:100%; height:300px; padding:10px; }
  #map { width:100%; height:650px; }
  .legend { 
    background: rgba(255,255,255,0.95); 
    padding:10px; 
    line-height:1.5em; 
    border-radius:5px; 
    max-height:300px; 
    overflow-y:auto;
    font-size:14px;
  }
  .legend-item { display:flex; align-items:center; margin-bottom:4px; }
  .legend-color { width:18px; height:18px; margin-right:8px; border-radius:3px; }
  .legend-symbol { width:18px; height:18px; height:auto; margin-right:8px; }
</style>
</head>
<body>

<div id="timelineContainer">
  <canvas id="timelineChart"></canvas>
</div>

<div id="map"></div>

<script>
// ---------------- TIMELINE ----------------
fetch('timeline.csv')
  .then(res=>res.text())
  .then(text=>{
    const rows=text.trim().split('\n').slice(1);
    const labels=[], usPersonnel=[], jpPersonnel=[], notes=[];
    rows.forEach(row=>{
      const cols=row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
      labels.push(cols[0].replace(/"/g,''));
      usPersonnel.push(parseInt(cols[1]));
      jpPersonnel.push(parseInt(cols[4]));
      notes.push(cols[7].replace(/"/g,''));
    });
    new Chart(document.getElementById('timelineChart'), {
      type:'bar',
      data:{
        labels:labels,
        datasets:[
          {label:'US Personnel', data:usPersonnel, backgroundColor:'#1F6FEB'},
          {label:'Japan Personnel', data:jpPersonnel, backgroundColor:'#D0021B'}
        ]
      },
      options:{
        indexAxis:'y',
        plugins:{ tooltip:{
          callbacks:{
            afterBody: function(ctx){ return 'Notes: '+notes[ctx[0].dataIndex]; }
          }
        }},
        responsive:true,
        maintainAspectRatio:false
      }
    });
  });

// ---------------- MAP ----------------
const map = L.map('map').setView([15,150],3);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// ---------------- LEGEND ----------------
const legend = L.control({position:'topright'});
legend.onAdd=function(map){
  const div=L.DomUtil.create('div','legend');
  div.innerHTML='<strong>Legend</strong><br>';
  div.innerHTML+='<div class="legend-item"><div class="legend-color" style="background:#D0021B"></div>Japan Offensive</div>';
  div.innerHTML+='<div class="legend-item"><div class="legend-color" style="background:#1F6FEB"></div>USA Offensive</div>';
  div.innerHTML+='<div class="legend-item"><div class="legend-color" style="background:#2E7D32"></div>US Army</div>';
  div.innerHTML+='<div class="legend-item"><div class="legend-color" style="background:#111111"></div>US Marines</div>';
  div.innerHTML+='<div class="legend-item"><img class="legend-symbol" src="https://upload.wikimedia.org/wikipedia/commons/8/8a/Font_Awesome_5_solid_bomb.svg">Major Bombing</div>';
  div.innerHTML+='<div class="legend-item"><img class="legend-symbol" src="https://upload.wikimedia.org/wikipedia/commons/6/6e/Noun_project_nuclear-explosion_icon.svg">Atomic Bomb</div>';
  div.innerHTML+='<div class="legend-item"><img class="legend-symbol" src="https://upload.wikimedia.org/wikipedia/en/a/a4/Flag_of_the_United_States.svg">Surrender / Flag Raising</div>';
  return div;
};
legend.addTo(map);

// ---------------- MARKERS ----------------
function createIcon(url) {
  return L.icon({
    iconUrl: url,
    iconSize: [25,25],
    iconAnchor: [12,12],
    popupAnchor: [0,-10]
  });
}

fetch('points.csv')
  .then(res=>res.text())
  .then(text=>{
    const rows=text.trim().split('\n').slice(1);
    rows.forEach(row=>{
      const cols=row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
      const lat=parseFloat(cols[4]);
      const lon=parseFloat(cols[5]);
      const label=cols[12].replace(/"/g,'');
      const desc=cols[8].replace(/"/g,'');
      const url=cols[9].replace(/"/g,'');
      const color=cols[10];
      const iconURL=cols[11];

      let marker;
      if(iconURL && iconURL.length>0){
        marker=L.marker([lat,lon],{icon:createIcon(iconURL)}).addTo(map);
      } else {
        marker=L.circleMarker([lat,lon],{
          radius:6,
          color:color,
          fillColor:color,
          fillOpacity:0.8
        }).addTo(map);
      }

      marker.bindPopup(`<b>${label}</b><br>${desc}<br><a href="${url}" target="_blank">Source</a>`, {maxWidth:250});
    });
  });

// ---------------- PATHS ----------------
fetch('paths.geojson')
  .then(res=>res.json())
  .then(data=>{
    L.geoJSON(data,{
      style: f=>f.properties.style
    }).addTo(map);
  });

</script>

</body>
</html>
