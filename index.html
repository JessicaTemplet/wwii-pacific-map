<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Righteous Might: Victory over Japan in WWII</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- PapaParse (robust CSV parsing) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{--map-height:72vh;--timeline-height:24vh}
    body{margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:#f8f9fa;color:#111}
    header{padding:12px 16px;text-align:center}
    header h1{margin:0;font-size:20px}
    #timelineWrap{width:94%;max-width:1100px;margin:10px auto;height:var(--timeline-height)}
    #timeline{width:100%;height:100%}
    #map{width:100%;height:var(--map-height);box-shadow:0 2px 10px rgba(0,0,0,0.06)}
    
    /* Fixed legend positioning - bottom right with better visibility */
    .legend{
      position: absolute !important;
      bottom: 20px !important;
      right: 20px !important;
      background: rgba(255,255,255,0.95) !important;
      padding: 12px !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
      font-size: 12px !important;
      line-height: 1.4 !important;
      max-width: 220px !important;
      z-index: 1000 !important;
      border: 1px solid rgba(0,0,0,0.1) !important;
    }
    .legend-title{font-weight:bold;margin-bottom:8px;color:#333;font-size:13px}
    .legend-row{display:flex;align-items:center;margin-bottom:5px}
    .legend-swatch{width:16px;height:12px;margin-right:8px;border-radius:3px;border:1px solid rgba(0,0,0,0.2);flex-shrink:0}
    .legend-symbol{width:16px;height:16px;margin-right:8px;display:inline-block;vertical-align:middle;flex-shrink:0}
    .legend-text{font-size:11px;color:#333}
    .legend-section{margin-bottom:8px}
    .legend-section-title{font-weight:bold;font-size:11px;color:#555;margin-bottom:3px}
    
    /* event count badge */
    #countBadge{position:fixed;right:14px;top:14px;background:#1F6FEB;color:#fff;padding:6px 10px;border-radius:999px;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,0.12);z-index:9999}
    a.source{color:#1F6FEB;text-decoration:none}
    
    /* Custom marker styles for numbered circles */
    .numbered-marker {
      background: #1F6FEB;
      border: 2px solid #fff;
      border-radius: 50%;
      color: #fff;
      font-weight: bold;
      text-align: center;
      font-size: 10px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .numbered-marker.japan { background: #D0021B; }
    .numbered-marker.joint { background: #7A3EE6; }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .legend { 
        max-width: 180px !important; 
        font-size: 11px !important;
        bottom: 10px !important;
        right: 10px !important;
      }
      .legend-text { font-size: 10px; }
      .numbered-marker { font-size: 9px; }
      header h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Righteous Might: Victory over Japan in World War II</h1>
  </header>

  <div id="timelineWrap">
    <canvas id="timeline"></canvas>
  </div>

  <div id="map" aria-label="WWII Pacific map"></div>

  <div id="countBadge" aria-live="polite">Events: ‚Äî</div>

<script>
/* ---------- Helper utilities ---------- */
function toFloat(v){ 
  const n = parseFloat((v||'').toString().replace(/[^0-9\.\-]/g,'')); 
  return isNaN(n) ? null : n; 
}
function stripQuotes(s){ return (s||'').toString().replace(/^"|"$/g,''); }

/* ---------- Config: fallback icons (public domain/SVG) ---------- */
const ICON_URLS = {
  bomb: 'https://upload.wikimedia.org/wikipedia/commons/8/8a/Font_Awesome_5_solid_bomb.svg',
  atomic: 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Noun_project_nuclear-explosion_icon.svg',
  flag: 'https://upload.wikimedia.org/wikipedia/en/a/a4/Flag_of_the_United_States.svg'
};

/* Preload an image and resolve true/false for availability */
function preloadImage(url) {
  return new Promise((resolve) => {
    if(!url) return resolve(false);
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    // set crossOrigin just in case (some hosts may deny)
    try { img.crossOrigin = 'anonymous'; } catch(e){}
    img.src = url;
    // timeout fallback
    setTimeout(()=>resolve(!!img.complete && img.naturalWidth > 0), 3000);
  });
}

/* Create a Leaflet icon object */
function makeLicon(url, size=26){
  return L.icon({ iconUrl: url, iconSize:[size,size], iconAnchor:[size/2,size/2], popupAnchor:[0,-size/2] });
}

/* Create numbered circle marker */
function createNumberedIcon(number, side = 'USA') {
  let markerClass = '';
  if (side.toLowerCase() === 'japan') markerClass = 'japan';
  else if (side.toLowerCase() === 'joint') markerClass = 'joint';
  
  return L.divIcon({
    html: `<div class="numbered-marker ${markerClass}" style="width: 26px; height: 26px;">${number}</div>`,
    className: 'custom-div-icon',
    iconSize: [26, 26],
    iconAnchor: [13, 13],
    popupAnchor: [0, -13]
  });
}

/* ---------- Load timeline.csv (PapaParse) ---------- */
async function loadAndRenderTimeline(){
  try{
    const txt = await (await fetch('timeline.csv')).text();
    const res = Papa.parse(txt, { header:true, skipEmptyLines:true });
    const rows = res.data;

    const labels = rows.map(r=>stripQuotes(r.Year));
    const us = rows.map(r => +r['US Total Personnel'] || 0);
    const jp = rows.map(r => +r['Japan Total Personnel'] || 0);
    const notes = rows.map(r => stripQuotes(r.Notes || ''));

    const ctx = document.getElementById('timeline').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { 
            label:'US Personnel (thousands)', 
            data: us, 
            backgroundColor: '#1F6FEB',
            borderColor: '#0F4C81',
            borderWidth: 1
          },
          { 
            label:'Japan Personnel (thousands)', 
            data: jp, 
            backgroundColor: '#D0021B',
            borderColor: '#A0011A',
            borderWidth: 1
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Pacific Theater Military Personnel by Year',
            font: { size: 14 }
          },
          tooltip: {
            callbacks: {
              afterBody: function(items){
                const i = items[0].dataIndex || 0;
                return notes[i] ? ('Notes: ' + notes[i]) : '';
              },
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.x.toLocaleString();
              }
            }
          },
          legend: { 
            position: 'top',
            labels: { usePointStyle: true }
          }
        },
        scales: { 
          x: { 
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          }
        }
      }
    });
  } catch(e) {
    console.error('Timeline error', e);
  }
}

/* ---------- Load points.csv and paths.geojson, render map ---------- */
async function loadAndRenderMap(){
  // Define Pacific Theater bounds to prevent world-wrapping
  const pacificBounds = [
    [-40, 90],   // Southwest: Australia area, east of Asia
    [70, -90]    // Northeast: Alaska, west coast of Americas
  ];

  const map = L.map('map', { 
    preferCanvas: true,
    maxBounds: pacificBounds,
    maxBoundsViscosity: 1.0, // Prevents dragging outside bounds
    minZoom: 2,
    maxZoom: 10
  }).setView([18, 145], 3);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);

  // Create comprehensive legend
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div class="legend-title">WWII Pacific Theater</div>
      <div class="legend-section">
        <div class="legend-section-title">Forces</div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#D0021B"></span>
          <span class="legend-text">Japanese offensive</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#1F6FEB"></span>
          <span class="legend-text">US/Allied offensive</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#7A3EE6"></span>
          <span class="legend-text">Joint operations</span>
        </div>
      </div>
      <div class="legend-section">
        <div class="legend-section-title">Special Events</div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#FF6B35;border-radius:3px;">üí£</span>
          <span class="legend-text">Major bombing</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#FF0000;border-radius:3px;">‚ò¢Ô∏è</span>
          <span class="legend-text">Atomic weapons</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#00AA00;border-radius:3px;">üè≥Ô∏è</span>
          <span class="legend-text">Surrender/Flag raising</span>
        </div>
      </div>
      <div style="font-size:10px;color:#666;margin-top:8px;">
        Numbers indicate chronological order
      </div>
    `;
    return div;
  };
  legend.addTo(map);

  // Load data files
  const [pointsTxt, pathsJson] = await Promise.all([
    fetch('points.csv').then(r=>r.text()).catch(e => {
      console.error('Failed to load points.csv:', e);
      return '';
    }),
    fetch('paths.geojson').then(r=>r.json()).catch(e => {
      console.warn('Failed to load paths.geojson:', e);
      return null;
    })
  ]);

  if (!pointsTxt) {
    console.error('No points data available');
    document.getElementById('countBadge').textContent = 'Error: No data';
    return;
  }

  const parsed = Papa.parse(pointsTxt, { header:true, skipEmptyLines:true });
  const rows = parsed.data || [];
  console.log('Parsed points rows:', rows.length);

  // Gather unique symbol URLs to test availability
  const symbolUrls = {};
  rows.forEach(r => {
    const raw = stripQuotes(r.marker_symbol || r.marker || '');
    if(raw && raw.toLowerCase().startsWith('http')) symbolUrls[raw] = null;
    // also check if marker_symbol equals one of keyword names 'bomb','atomic','flag'
    if(!raw && (r.type || '').toLowerCase() === 'bombing') symbolUrls[ICON_URLS.bomb] = null;
    if(!raw && (r.type || '').toLowerCase() === 'atomic') symbolUrls[ICON_URLS.atomic] = null;
    if(!raw && (r.type || '').toLowerCase().includes('flag')) symbolUrls[ICON_URLS.flag] = null;
  });

  // Also ensure known icons are available (these are the Wikimedia ones used heavily)
  Object.values(ICON_URLS).forEach(u=>symbolUrls[u] = null);

  // Preload all symbol URLs
  const symbolKeys = Object.keys(symbolUrls);
  await Promise.all(symbolKeys.map(async url => {
    try {
      const ok = await preloadImage(url);
      if(ok) symbolUrls[url] = makeLicon(url, 28);
      else symbolUrls[url] = null;
    } catch(e){
      symbolUrls[url] = null;
    }
  }));

  // Add markers with proper coordinate validation
  const markerLayer = L.featureGroup();
  let validMarkers = 0;
  let skippedMarkers = 0;
  
  rows.forEach((r, idx) => {
    // CRITICAL FIX: Extract coordinates with proper validation and forced numeric conversion
    const latRaw = r.lat || r.Lat || r.Latitude || r.latitude;
    const lonRaw = r.lon || r.Lon || r.Longitude || r.longitude;
    
    // Convert to numbers with explicit validation
    const lat = toFloat(latRaw);
    const lon = toFloat(lonRaw);
    
    // Enhanced coordinate validation with detailed logging
    if(lat === null || lon === null) {
      console.warn(`Row ${idx}: NULL coordinates - lat: ${latRaw} -> ${lat}, lon: ${lonRaw} -> ${lon}, name: ${r.name}`);
      skippedMarkers++;
      return;
    }
    
    if(lat < -90 || lat > 90) {
      console.warn(`Row ${idx}: Invalid latitude ${lat} for ${r.name}`);
      skippedMarkers++;
      return;
    }
    
    if(lon < -180 || lon > 180) {
      console.warn(`Row ${idx}: Invalid longitude ${lon} for ${r.name}`);
      skippedMarkers++;
      return;
    }
    
    // Log specific problematic locations for debugging
    if(r.name && (r.name.toLowerCase().includes('pearl') || r.name.toLowerCase().includes('aleutian') || r.name.toLowerCase().includes('midway'))) {
      console.log(`${r.name}: lat=${lat}, lon=${lon} (from raw: ${latRaw}, ${lonRaw})`);
    }
    
    // Extract all relevant data
    const name = stripQuotes(r.name || r.Name || '');
    const label = stripQuotes(r.label || r.Label || name);
    const short_desc = stripQuotes(r.short_desc || r.Short_desc || r.description || r.Description || '');
    const source = stripQuotes(r.source_url || r.source || r.Source_url || r.Source || '');
    const color = stripQuotes(r.marker_color || r.color || '#1F6FEB');
    let rawSymbol = stripQuotes(r.marker_symbol || r.marker || r.symbol || '');
    const sideOffensive = stripQuotes(r.side_offensive || r.Side_offensive || 'USA');
    const type = stripQuotes(r.type || r.Type || '').toLowerCase();
    
    let marker = null;
    
    // Detect if rawSymbol is a URL and has a preloaded icon
    if(rawSymbol && rawSymbol.toLowerCase().startsWith('http') && symbolUrls[rawSymbol]) {
      marker = L.marker([lat, lon], { icon: symbolUrls[rawSymbol] });
    } 
    // Check for keyword-based icons
    else if(rawSymbol === 'bomb' && symbolUrls[ICON_URLS.bomb]) {
      marker = L.marker([lat, lon], { icon: symbolUrls[ICON_URLS.bomb] });
    }
    else if(rawSymbol === 'atomic' && symbolUrls[ICON_URLS.atomic]) {
      marker = L.marker([lat, lon], { icon: symbolUrls[ICON_URLS.atomic] });
    }
    else if(rawSymbol === 'flag' && symbolUrls[ICON_URLS.flag]) {
      marker = L.marker([lat, lon], { icon: symbolUrls[ICON_URLS.flag] });
    }
    // Auto-detect based on event type
    else if(type.includes('bombing') && symbolUrls[ICON_URLS.bomb]) {
      marker = L.marker([lat, lon], { icon: symbolUrls[ICON_URLS.bomb] });
    }
    else if(type.includes('atomic') && symbolUrls[ICON_URLS.atomic]) {
      marker = L.marker([lat, lon], { icon: symbolUrls[ICON_URLS.atomic] });
    }
    else if((type.includes('flag') || type.includes('surrender')) && symbolUrls[ICON_URLS.flag]) {
      marker = L.marker([lat, lon], { icon: symbolUrls[ICON_URLS.flag] });
    }

    // If still no marker (either no icon or icon failed), create numbered marker
    if(!marker){
      const number = rawSymbol || (idx + 1);
      marker = L.marker([lat, lon], { icon: createNumberedIcon(number, sideOffensive) });
    }

    // Create popup with rich content
    let popup = `<strong>${label || name || 'Event ' + (idx + 1)}</strong>`;
    if(short_desc) popup += `<br>${short_desc}`;
    if(source) popup += `<br><a class="source" href="${source}" target="_blank" rel="noopener">Source</a>`;
    
    marker.addTo(markerLayer).bindPopup(popup, { maxWidth: 320, keepInView:true });
    validMarkers++;
  });

  markerLayer.addTo(map);
  console.log(`Added ${validMarkers} valid markers, skipped ${skippedMarkers} invalid markers`);

  // Add paths if present
  if(pathsJson && pathsJson.features){
    L.geoJSON(pathsJson, {
      style: f => {
        const p = f.properties || {};
        const s = p.style || {};
        const color = s.stroke || s.color || '#555';
        const weight = s['stroke-width'] || s.weight || 2;
        const dashArray = s['stroke-dasharray'] || s.dashArray || '6,4';
        const opacity = s.opacity || 0.7;
        return { color: color, weight: weight, dashArray: dashArray, opacity: opacity };
      },
      onEachFeature: (f,l) => {
        if(f.properties) {
          const service = f.properties.service || f.properties.name || 'Military Operation';
          l.bindPopup(`<strong>${service}</strong>`);
        }
      }
    }).addTo(map);
    console.log('Added campaign paths from GeoJSON');
  }

  // Fit bounds to markers if we have any
  if(markerLayer.getLayers().length > 0){
    try { 
      map.fitBounds(markerLayer.getBounds().pad(0.05)); 
    } catch(e){ 
      console.warn('fitBounds failed:', e); 
    }
  }

  // Update badge with final count
  document.getElementById('countBadge').textContent = `Events: ${validMarkers}${skippedMarkers > 0 ? ` (${skippedMarkers} skipped)` : ''}`;
}

/* ---------- Error handling and startup ---------- */
window.addEventListener('error', function(e) {
  console.error('Global error:', e.error);
});

(async function(){
  try {
    console.log('Starting application...');
    await loadAndRenderTimeline();
    console.log('Timeline loaded successfully');
    await loadAndRenderMap();
    console.log('Map loaded successfully');
  } catch(e) {
    console.error('Startup error:', e);
    document.getElementById('countBadge').textContent = 'Error loading';
  }
})();
</script>
</body>
</html>
