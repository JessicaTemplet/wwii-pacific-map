<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Righteous Might: Victory over Japan in WWII</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; }
    #map { height: 70vh; width: 100%; }
    #timeline { height: 30vh; }
    .legend {
      background: white;
      padding: 6px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      font-size: 14px;
      line-height: 18px;
    }
    .legend-item { display:flex; align-items:center; margin-bottom:4px; }
    .legend-color {
      width:14px; height:14px; margin-right:6px; border:1px solid #000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="timeline"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <script>
    // Load CSV and GeoJSON files
    async function loadData() {
      const [pointsCSV, pathsGeo, timelineCSV] = await Promise.all([
        fetch("points.csv").then(res => res.text()),
        fetch("paths.geojson").then(res => res.json()),
        fetch("timeline.csv").then(res => res.text())
      ]);
      return { pointsCSV, pathsGeo, timelineCSV };
    }

    function parseCSV(text) {
      const rows = d3.csvParse(text);
      return rows;
    }

    function initMap(pointsData, pathsData) {
      const map = L.map('map').setView([20, 150], 3);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 8,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // ---------------- LEGEND ----------------
      const legend = L.control({ position: 'bottomleft' });
      legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<b>Legend</b><br>';
        div.innerHTML += '<div class="legend-item"><div class="legend-color" style="background:#D0021B"></div>Japan Offensive</div>';
        div.innerHTML += '<div class="legend-item"><div class="legend-color" style="background:#1F6FEB"></div>USA Offensive</div>';
        div.innerHTML += '<div class="legend-item"><div class="legend-color" style="background:#7A3EE6"></div>Joint Operations</div>';
        return div;
      };
      legend.addTo(map);

      // center legend with CSS
      setTimeout(() => {
        const legendEl = document.querySelector('.legend');
        if (legendEl) {
          legendEl.style.position = 'absolute';
          legendEl.style.left = '50%';
          legendEl.style.bottom = '10px';
          legendEl.style.transform = 'translateX(-50%)';
        }
      }, 500);

      // ---------------- PATHS ----------------
      L.geoJSON(pathsData, {
        style: { color: "#555", weight: 2, opacity: 0.6 }
      }).addTo(map);

      // ---------------- MARKERS ----------------
      try {
        const pointRows = parseCSV(pointsData);

        pointRows.forEach(row => {
          const lat = parseFloat(row.lat);
          const lon = parseFloat(row.lon);
          const name = row.name;
          const desc = row.short_desc;
          const url = row.source_url || '';
          const color = row.marker_color || '#1F6FEB';
          const symbol = row.marker_symbol;

          if (isNaN(lat) || isNaN(lon)) return;

          let marker;
          let radius = 6;

          if (row.type === 'atomic') radius = 12;
          else if (row.type === 'surrender' || row.type === 'flag-raising') radius = 10;
          else if (row.type === 'bombing') radius = 8;

          if (symbol && symbol.startsWith('http')) {
            const icon = L.icon({
              iconUrl: symbol,
              iconSize: [24, 24],
              iconAnchor: [12, 12],
              popupAnchor: [0, -12]
            });
            marker = L.marker([lat, lon], { icon: icon }).addTo(map);
          } else {
            marker = L.circleMarker([lat, lon], {
              radius: radius,
              fillColor: color,
              color: "#000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map);
          }

          const popupContent = `<b>${name}</b><br>${desc}${url ? '<br><a href="' + url + '" target="_blank">Source</a>' : ''}`;
          marker.bindPopup(popupContent, { maxWidth: 250 });
        });

      } catch (error) {
        console.error('Markers error:', error);
      }
    }

    function initTimeline(timelineData) {
      const rows = parseCSV(timelineData);
      const years = rows.map(d => +d.Year);
      const usPersonnel = rows.map(d => +d["US Total Personnel"]);
      const japanPersonnel = rows.map(d => +d["Japan Total Personnel"]);

      const svg = d3.select("#timeline").append("svg")
        .attr("width", "100%")
        .attr("height", "100%");

      const width = document.getElementById("timeline").clientWidth;
      const height = document.getElementById("timeline").clientHeight;

      const x = d3.scaleLinear().domain(d3.extent(years)).range([50, width-50]);
      const y = d3.scaleLinear().domain([0, d3.max([...usPersonnel, ...japanPersonnel])]).range([height-40, 20]);

      const lineUS = d3.line().x((d,i) => x(years[i])).y((d,i) => y(usPersonnel[i]));
      const lineJapan = d3.line().x((d,i) => x(years[i])).y((d,i) => y(japanPersonnel[i]));

      svg.append("path")
        .datum(usPersonnel)
        .attr("fill", "none")
        .attr("stroke", "#1F6FEB")
        .attr("stroke-width", 2)
        .attr("d", lineUS);

      svg.append("path")
        .datum(japanPersonnel)
        .attr("fill", "none")
        .attr("stroke", "#D0021B")
        .attr("stroke-width", 2)
        .attr("d", lineJapan);

      svg.append("g")
        .attr("transform", `translate(0,${height-40})`)
        .call(d3.axisBottom(x).tickFormat(d3.format("d")));

      svg.append("g")
        .attr("transform", `translate(50,0)`)
        .call(d3.axisLeft(y));
    }

    loadData().then(({pointsCSV, pathsGeo, timelineCSV}) => {
      initMap(pointsCSV, pathsGeo);
      initTimeline(timelineCSV);
    });
  </script>
</body>
</html>
