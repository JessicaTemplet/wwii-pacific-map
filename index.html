<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Righteous Might: Victory over Japan in World War II</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
    #timeline {
      height: 250px;
      width: 100%;
    }
    #legend {
      background: white;
      padding: 10px;
      line-height: 1.5em;
      font-size: 14px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      max-width: 250px;
    }
    .legend-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Righteous Might: Victory over Japan in World War II</h1>
  <div id="map"></div>
  <div id="timeline"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map("map").setView([20, 160], 3);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // Custom icons
    function createIcon(url) {
      return L.icon({
        iconUrl: url,
        iconSize: [25, 25],
        iconAnchor: [12, 12],
        popupAnchor: [0, -12],
      });
    }

    // Legend
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.id = "legend";
      div.innerHTML = `
        <div class="legend-title">WWII Pacific Theater</div>
        <div><img src="icons/red.png" width="16"> Japanese offensive</div>
        <div><img src="icons/blue.png" width="16"> US/Allied offensive</div>
        <div><img src="icons/purple.png" width="16"> Joint operations</div>
        <div><img src="icons/yellow.png" width="16"> Special Events</div>
        <div><img src="icons/orange.png" width="16"> Major bombing</div>
        <div><img src="icons/black.png" width="16"> Atomic</div>
        <div><img src="icons/green.png" width="16"> Surrender/Flag-raising</div>
        <div>Numbers indicate chronological order</div>
      `;
      return div;
    };
    legend.addTo(map);

    // Load points.csv
    fetch("points.csv")
      .then((res) => res.text())
      .then((pointsTxt) => {
        const parsed = Papa.parse(pointsTxt, {
          header: true,
          skipEmptyLines: true,
        });
        const rows = parsed.data;

        rows.forEach((row) => {
          const id = row.id;
          const name = row.name;
          const lat = row.lat;
          const lon = row.lon;
          const year = row.year;
          const notes = row.notes;
          const iconURL = row.icon;

          if (lat && lon) {
            const marker = L.marker(
              [Number(lat), Number(lon)],
              { icon: createIcon(iconURL) }
            ).addTo(map);
            marker.bindPopup(
              `<b>${id}. ${name} (${year})</b><br>${notes}`
            );
          }
        });

        console.log("Events:", rows.length);
      });

    // Load timeline.csv
    fetch("timeline.csv")
      .then((res) => res.text())
      .then((csvText) => {
        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
        });
        const data = parsed.data;

        const years = data.map((row) => row.Year);
        const usPersonnel = data.map((row) => +row["US Total Personnel"]);
        const jpPersonnel = data.map((row) => +row["Japan Total Personnel"]);

        new Chart(document.getElementById("timeline"), {
          type: "line",
          data: {
            labels: years,
            datasets: [
              {
                label: "US Personnel",
                data: usPersonnel,
                borderColor: "blue",
                fill: false,
              },
              {
                label: "Japan Personnel",
                data: jpPersonnel,
                borderColor: "red",
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
              title: {
                display: true,
                text: "Troop Strength Over Time",
              },
            },
          },
        });
      });
  </script>
</body>
</html>
