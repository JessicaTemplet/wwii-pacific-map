<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Righteous Might: Victory over Japan in World War II</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css"/>
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; }
    #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:1000; }
    .topbar { position:absolute; top:0; left:0; right:0; height:70px; background:#0b2545; color:#fff; display:flex; align-items:center; padding:10px 16px; z-index:2000; }
    .timeline { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .year-pill { background:rgba(255,255,255,0.1); padding:6px 10px; border-radius:4px; color:#fff; cursor:pointer; }
    .year-tooltip { position:absolute; top:70px; right:12px; background:#fff; color:#000; padding:8px; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.3); font-size:13px; display:none; max-width:300px; z-index:3000; }
    .legend-box { position:absolute; left:12px; bottom:12px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.25); font-size:13px; z-index:2000; }
    .credits-box { position:absolute; right:12px; bottom:12px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.25); font-size:13px; z-index:2000; }
    .legend-entry { display:flex; align-items:center; margin-bottom:5px; }
    .legend-entry span { margin-left:8px; }
    .swatch { width:12px; height:12px; border-radius:50%; }
    .popup { background:#fff; padding:8px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.25); max-width:300px; font-size:13px; }
    .popup img { width:100%; height:90px; object-fit:cover; border-radius:4px; margin-bottom:6px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar">
    <div class="title">Righteous Might: Victory over Japan in World War II</div>
    <div class="timeline" id="timeline"></div>
  </div>
  <div class="year-tooltip" id="yearTooltip"></div>
  <div class="legend-box" id="legendBox">Legend loading...</div>
  <div class="credits-box">Created by Thug Adams<br/><a href="https://thugadams.substack.com" target="_blank">thugadams.substack.com</a></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    console.log("DEBUG: script started");

    // --- ICON AND LEGEND DATA ---
    function svgDataUrl(svg) { return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }
    const ICONS = {
      japanese_offensive: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#D0021B'/></svg>`),
      us_offensive: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#1F6FEB'/></svg>`),
      joint: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#D0021B'/><stop offset='1' stop-color='#1F6FEB'/></linearGradient></defs><circle cx='18' cy='18' r='12' fill='url(#g)'/></svg>`),
      bomb: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#f0ad4e'/></svg>`),
      atomic: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><circle cx='20' cy='20' r='14' fill='#f44336'/><text x='20' y='24' font-size='12' font-weight='700' text-anchor='middle' fill='#fff'>A</text></svg>`),
      surrender: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#0000FF'/></svg>`),
      default: svgDataUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><circle cx='18' cy='18' r='12' fill='#cccccc'/></svg>`)
    };

    const LEGEND_ITEMS = [
      { type: 'japanese_offensive', label: 'Japanese Offensive', color: '#D0021B' },
      { type: 'us_offensive', label: 'U.S. Offensive', color: '#1F6FEB' },
      { type: 'joint', label: 'Joint Operations', color: '#7A3EE6' },
      { type: 'bomb', label: 'Bombing', color: '#f0ad4e' },
      { type: 'atomic', label: 'Atomic Bombing', color: '#f44336' },
      { type: 'surrender', label: 'Surrender/Symbolic', color: '#0000FF' }
    ];

    function renderLegend() {
      const legendBox = document.getElementById('legendBox');
      let html = '<h4>Map Legend</h4>';
      LEGEND_ITEMS.forEach(item => {
        html += `<div class="legend-entry">
                   <div class="swatch" style="background:${item.color};"></div>
                   <span>${item.label}</span>
                 </div>`;
      });
      legendBox.innerHTML = html;
    }

    function renderTimeline(features) {
      const timelineEl = document.getElementById('timeline');
      const years = new Set();
      features.forEach(feature => {
        const year = feature.get('start_date').substring(0, 4);
        years.add(year);
      });
      const sortedYears = Array.from(years).sort();
      timelineEl.innerHTML = sortedYears.map(year => `<div class="year-pill" data-year="${year}">${year}</div>`).join('');
    }

    // --- MAP INITIALIZATION ---
    try {
      const map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([150, 5]),
          zoom: 3,
          minZoom: 2
        })
      });
      console.log("DEBUG: base map layer initialized");

      const vectorSource = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: 'events.geojson'
      });

      const vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: feature => {
          const mt = feature.get('marker_type');
          let iconUrl = ICONS[mt] || ICONS.default;
          
          return new ol.style.Style({
            image: new ol.style.Icon({ src: iconUrl, scale: 0.9, anchor: [0.5, 0.5] }),
            text: new ol.style.Text({
              text: feature.get('id').toString(),
              fill: new ol.style.Fill({ color: '#fff' }),
              font: 'bold 12px sans-serif',
              offsetY: 0,
            })
          });
        }
      });
      map.addLayer(vectorLayer);

      vectorSource.once('change', function(e) {
        if (vectorSource.getState() === 'ready') {
          const features = vectorSource.getFeatures();
          renderTimeline(features);
          renderLegend();
          console.log("DEBUG: Data loaded. Timeline and legend rendered.");
        }
      });

      const popupEl = document.createElement('div');
      popupEl.className = 'popup';
      const overlay = new ol.Overlay({
        element: popupEl,
        autoPan: { animation: { duration: 250 } }
      });
      map.addOverlay(overlay);

      map.on('singleclick', evt => {
        const f = map.forEachFeatureAtPixel(evt.pixel, ft => ft);
        if (!f) {
          overlay.setPosition(undefined);
          return;
        }
        const props = f.getProperties();
        let content = `<h3>${props.title}</h3><div style="font-size:12px;color:#666;">${props.start_date}${props.end_date ? ' â€” ' + props.end_date : ''}</div>`;
        content += props.short_desc ? `<div>${props.short_desc}</div>` : '';
        content += props.source ? `<div style="margin-top:6px;font-size:12px;"><a href="${props.source}" target="_blank">Read more</a></div>` : '';
        popupEl.innerHTML = content;
        overlay.setPosition(evt.coordinate);
      });

      console.log("DEBUG: map & vector layer and popup set up");

    } catch (err) {
      console.error("DEBUG: fatal map init error:", err);
    }
  </script>
</body>
</html>

