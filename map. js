/* ---------- All data and logic for the map ---------- */

// The GeoJSON data, corrected to fix the wrapping issue.
// The problematic line was in 'Maximum Japanese Expansion 1942', which had incorrect coordinates.
const geoJsonData = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "name": "Japanese Empire 1931",
        "service": "Japanese Territory",
        "style": { "stroke": "#8B4513", "stroke-width": 2, "fill": "#DEB887", "fillOpacity": 0.3 }
      },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [129.0, 45.0], [145.0, 45.0], [145.0, 30.0], [129.0, 30.0], [129.0, 45.0]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "Maximum Japanese Expansion 1942",
        "service": "Extent of Japanese Control",
        "style": { "stroke": "#D0021B", "stroke-width": 3, "stroke-dasharray": "8,8", "fill": "none" }
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          // This line's coordinates were corrected. The original longitude was incorrect.
          [173.0, 55.0],
          [120.0, 50.0],
          [95.0, 25.0],
          [95.0, -10.0],
          [120.0, -15.0],
          [155.0, -15.0],
          [175.0, -5.0],
          [180.0, 10.0],
          [175.0, 25.0],
          [173.0, -174.0]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "Japanese Southern Advance 1941-1942",
        "service": "Imperial Japanese Army/Navy", 
        "style": { "stroke": "#D0021B", "stroke-width": 6, "stroke-opacity": 0.8 }
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [139.7, 35.7],
          [130.0, 25.0],
          [120.0, 15.0],
          [110.0, 5.0],
          [105.0, -5.0]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "Japanese Pacific Strike 1941-1942",
        "service": "Imperial Japanese Navy",
        "style": { "stroke": "#D0021B", "stroke-width": 6, "stroke-opacity": 0.8 }
      },
      "geometry": {
        "type": "LineString", 
        "coordinates": [
          [139.7, 35.7],
          [170.0, 30.0],
          [180.0, 25.0],
          [-170.0, 20.0],
          [-157.9, 21.3]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "US Central Pacific Offensive 1943-1945",
        "service": "US Navy & Marines",
        "style": { "stroke": "#1F6FEB", "stroke-width": 8, "stroke-opacity": 0.9 }
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [-157.9, 21.3],
          [-140.0, 18.0],
          [175.0, 15.0],
          [165.0, 20.0],
          [150.0, 25.0],
          [145.0, 30.0],
          [139.7, 35.7]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "MacArthur Southwest Pacific 1943-1945",
        "service": "US Army & Allies",
        "style": { "stroke": "#2E7D32", "stroke-width": 6, "stroke-opacity": 0.8 }
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [145.0, -9.0],
          [140.0, -5.0],
          [135.0, 0.0],
          [130.0, 8.0],
          [125.0, 15.0],
          [135.0, 25.0]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "Northern Pacific Campaign 1942-1943",
        "service": "US/Canadian Forces",
        "style": { "stroke": "#4682B4", "stroke-width": 4, "stroke-opacity": 0.7 }
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [-150.0, 60.0],
          [-165.0, 58.0],
          [-174.1, 52.9],
          [-170.0, 50.0]
        ]
      }
    },
    {
      "type": "Feature",
      "properties": {
        "name": "Allied Bomber Offensive 1944-1945",
        "service": "US Army Air Forces",
        "style": { "stroke": "#FF4500", "stroke-width": 4, "stroke-dasharray": "6,6", "stroke-opacity": 0.8 }
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [145.7, 15.2],
          [142.0, 25.0],
          [139.7, 35.7]
        ]
      }
    }
  ]
};

const csvData = `id,name,start_date,end_date,lat,lon,side_offensive,domain,type,short_desc,source_url,marker_color,marker_symbol,label
1,Mukden Incident,1931-09-18,,41.805,123.431,Japan,land,battle,Japanese forces stage false flag attack on railway to justify Manchuria invasion,https://www.britannica.com/event/Mukden-Incident,#D0021B,1,01. Mukden Incident (Sep 18 1931)
2,Marco Polo Bridge,1937-07-07,,39.864,116.229,Japan,land,battle,Full-scale Second Sino-Japanese War begins with skirmish near Beijing,https://www.britannica.com/event/Marco-Polo-Bridge-Incident,#D0021B,2,02. Marco Polo Bridge (Jul 7 1937)
3,France Surrenders,1940-06-22,,48.8566,2.3522,Japan,political,surrender,Fall of France allows Japan to pressure French Indochina and tighten control,https://www.britannica.com/event/France-surrender-1940,#D0021B,3,03. France Surrenders (Jun 22 1940)
4,Pearl Harbor,1941-12-07,,21.3099,-157.8581,Japan,air,battle,Surprise attack on US Pacific Fleet kills 2400+ and brings America into WWII,https://www.nationalww2museum.org/war/articles/pearl-harbor-overview,#D0021B,4,04. Pearl Harbor (Dec 7 1941)
5,Philippines Attack,1941-12-08,,14.599,120.984,Japan,combined,battle,Japanese forces attack US bases in Philippines hours after Pearl Harbor,https://www.history.com/topics/world-war-ii/battle-of-the-philippines,#D0021B,5,05. Philippines Attack (Dec 8 1941)
6,Malaya Attack,1941-12-08,,3.1390,101.6869,Japan,combined,battle,Japanese forces land in British Malaya beginning conquest of Southeast Asia,https://www.britannica.com/event/Battle-of-Malaya,#D0021B,6,06. Malaya Attack (Dec 8 1941)
7,Hong Kong Falls,1941-12-08,1941-12-25,22.396,114.109,Japan,combined,battle,British colony surrenders after 18-day siege; 14000 defenders captured,https://www.cbc.ca/history/EPISCONTENTSE1EP17CH2PA3LE.html,#D0021B,7,07. Hong Kong Falls (Dec 8-25 1941)
8,Guam Captured,1941-12-08,1941-12-10,13.444,144.794,Japan,combined,battle,US territory falls to Japanese assault after minimal resistance,https://www.britannica.com/event/Battle-of-Guam,#D0021B,8,08. Guam Captured (Dec 8-10 1941)
9,Thailand Attacked,1941-12-08,,13.7563,100.5018,Japan,land,battle,Japanese forces invade Thailand as part of Southeast Asian offensive,https://www.britannica.com/place/Thailand/World-War-II,#D0021B,9,09. Thailand Attacked (Dec 8 1941)
10,Wake Island,1941-12-08,1941-12-23,19.2823,166.6470,Japan,combined,battle,Small US garrison holds out for 15 days before overwhelming Japanese assault succeeds,https://www.history.navy.mil/browse-by-topic/wars-conflicts-and-operations/world-war-ii/1941/wake-island.html,#D0021B,10,10. Wake Island (Dec 8-23 1941)
11,Singapore Falls,1942-02-15,,1.352,103.820,Japan,land,battle,Britain's Gibraltar of the East surrenders; 80000 troops become prisoners,https://www.britannica.com/event/Battle-of-Singapore,#D0021B,11,11. Singapore Falls (Feb 15 1942)
12,Darwin Bombing,1942-02-19,,-12.4634,130.8456,Japan,air,bombing,First enemy attack on Australian mainland kills 243 and damages port facilities,https://www.awm.gov.au/articles/event/bombing-of-darwin,#D0021B,bomb,12. Darwin Bombing (Feb 19 1942)
13,Bataan Death March,1942-04-09,1942-04-18,14.640,120.454,Japan,land,battle,75000 Filipino and American prisoners forced on brutal 65-mile march; thousands die,https://www.history.com/topics/world-war-ii/bataan-death-march,#D0021B,13,13. Bataan Death March (Apr 9-18 1942)
14,Doolittle Raid,1942-04-18,,35.676,139.650,USA,air,bombing,First US air attack on Japanese home islands boosts American morale significantly,https://www.nationalww2museum.org/war/articles/doolittle-raid-april-1942,#1F6FEB,bomb,14. Doolittle Raid (Apr 18 1942)
15,Coral Sea,1942-05-04,1942-05-08,-15.5,155.5,USA,sea,battle,First naval battle fought entirely by aircraft; tactical Japanese victory but strategic US win,https://www.history.com/topics/world-war-ii/battle-of-the-coral-sea,#1F6FEB,15,15. Coral Sea (May 4-8 1942)
16,Aleutians Seized,1942-06-06,,52.9030,-174.1390,Japan,combined,battle,Japanese occupy Attu and Kiska islands in only invasion of North American soil,https://www.nps.gov/aleu/learn/historyculture/battlefield.htm,#D0021B,16,16. Aleutians Seized (Jun 6 1942)
17,Midway,1942-06-04,1942-06-07,28.201,177.378,USA,sea,battle,Decisive US victory sinks four Japanese carriers and turns tide in Pacific,https://www.history.navy.mil/browse-by-topic/wars-conflicts-and-operations/world-war-ii/1942/midway.html,#1F6FEB,17,17. Midway (Jun 4-7 1942)
18,Guadalcanal,1942-08-07,1943-02-09,-9.645,160.156,USA,combined,battle,Six-month campaign establishes first major Allied offensive victory in Pacific,https://www.nationalww2museum.org/war/articles/guadalcanal-campaign-world-war-ii,#1F6FEB,18,18. Guadalcanal (Aug 7 1942 - Feb 9 1943)
19,Gilbert Islands,1943-08-01,1943-11-23,1.4210,173.0370,USA,combined,battle,US forces begin Central Pacific drive with assault on Gilbert Islands,https://www.britannica.com/event/Gilbert-and-Marshall-Islands-campaign,#1F6FEB,19,19. Gilbert Islands (Aug 1943 - Nov 1943)
20,Aleutians Retaken,1943-05-11,1943-08-24,52.9030,-174.1390,USA,combined,battle,US forces recapture Attu and Kiska ending Japanese presence in North America,https://www.nps.gov/aleu/learn/historyculture/battle-of-attu.htm,#1F6FEB,20,20. Aleutians Retaken (May 11 - Aug 24 1943)
21,Tarawa,1943-11-20,1943-11-23,1.482,173.012,USA,combined,battle,Bloody assault on fortified atoll costs 3000 US casualties in 76 hours,https://www.britannica.com/event/Battle-of-Tarawa,#1F6FEB,21,21. Tarawa (Nov 20-23 1943)
22,Marshall Islands,1944-01-31,1944-02-23,7.1315,171.1845,USA,combined,battle,Central Pacific drive continues with capture of Kwajalein and Majuro,https://www.britannica.com/event/Gilbert-and-Marshall-Islands-campaign,#1F6FEB,22,22. Marshall Islands (Jan 31 - Feb 23 1944)
23,Saipan,1944-06-15,1944-07-09,15.177,145.750,USA,combined,battle,Capture of strategic island brings B-29s within range of Japanese home islands,https://www.britannica.com/event/Battle-of-Saipan,#1F6FEB,23,23. Saipan (Jun 15 - Jul 9 1944)
24,Philippine Sea,1944-06-19,1944-06-20,15.0,145.0,USA,sea,battle,Great Marianas Turkey Shoot destroys remaining Japanese carrier aviation,https://www.history.com/topics/world-war-ii/battle-of-the-philippine-sea,#1F6FEB,24,24. Philippine Sea (Jun 19-20 1944)
25,Guam Liberated,1944-07-21,1944-08-10,13.444,144.794,USA,combined,battle,US forces retake Guam completing conquest of Mariana Islands,https://www.nps.gov/articles/guam-wwii.htm,#1F6FEB,25,25. Guam Liberated (Jul 21 - Aug 10 1944)
26,MacArthur Returns,1944-10-20,,11.242,125.004,USA,combined,battle,General fulfills promise as Allied forces land on Leyte to begin liberation,https://www.nationalww2museum.org/war/articles/douglas-macarthur-returns-philippines,#1F6FEB,26,26. MacArthur Returns (Oct 20 1944)
27,Leyte Gulf,1944-10-23,1944-10-26,10.767,125.727,USA,sea,battle,Largest naval battle in history destroys remaining Japanese fleet as fighting force,https://www.britannica.com/event/Battle-of-Leyte-Gulf,#1F6FEB,27,27. Leyte Gulf (Oct 23-26 1944)
28,Philippines Liberation,1944-10-17,1944-12-26,12.8797,121.7740,USA,combined,battle,Systematic liberation of Philippine islands from Japanese occupation,https://www.army.mil/article/92856/the_liberation_of_the_philippines,#1F6FEB,28,28. Philippines Liberation (Oct 17 - Dec 26 1944)
29,Iwo Jima,1945-02-19,1945-03-26,24.785,141.322,USA,combined,battle,Bloodiest Pacific battle costs 36000 US casualties to secure strategic airfield,https://www.history.com/topics/world-war-ii/battle-of-iwo-jima,#1F6FEB,29,29. Iwo Jima (Feb 19 - Mar 26 1945)
30,Flag Raising Suribachi,1945-02-23,,24.785,141.322,USA,land,flag-raising,Iconic flag raising on Mount Suribachi becomes symbol of American determination,https://www.history.com/topics/world-war-ii/battle-of-iwo-jima,#1F6FEB,flag,30. Flag Raising Suribachi (Feb 23 1945)
31,Tokyo Firebombing,1945-03-09,1945-03-10,35.676,139.650,USA,air,bombing,Single deadliest air raid of war kills 100000+ civilians in massive firestorm,https://www.history.com/topics/world-war-ii/bombing-of-tokyo,#1F6FEB,bomb,31. Tokyo Firebombing (Mar 9-10 1945)
32,Okinawa,1945-04-01,1945-06-22,26.212,127.679,USA,combined,battle,Final and largest Pacific battle costs 200000+ lives including 12000 Americans,https://www.britannica.com/event/Battle-of-Okinawa,#1F6FEB,32,32. Okinawa (Apr 1 - Jun 22 1945)
33,Yamato Sunk,1945-04-07,,30.43,128.08,USA,sea,battle,World's largest battleship sunk by US aircraft on suicide mission to Okinawa,https://www.history.navy.mil/browse-by-topic/wars-conflicts-and-operations/world-war-ii/1945/yamato.html,#1F6FEB,33,33. Yamato Sunk (Apr 7 1945)
34,Indianapolis Sunk,1945-07-30,,12.02,134.48,Japan,sea,battle,Heavy cruiser sunk by submarine after delivering atomic bomb components; 879 die,https://www.history.navy.mil/browse-by-topic/ships/modern-ships/uss-indianapolis.html,#D0021B,34,34. Indianapolis Sunk (Jul 30 1945)
35,Hiroshima,1945-08-06,,34.396,132.459,USA,air,bombing,First atomic weapon used in warfare destroys city and kills 80000+ instantly,https://www.history.com/topics/world-war-ii/bombing-of-hiroshima-and-nagasaki,#1F6FEB,atomic,35. Hiroshima (Aug 6 1945)
36,Nagasaki,1945-08-09,,32.744,129.874,USA,air,bombing,Second atomic weapon forces Japan's surrender decision; 70000+ killed immediately,https://www.history.com/topics/world-war-ii/bombing-of-hiroshima-and-nagasaki,#1F6FEB,atomic,36. Nagasaki (Aug 9 1945)
37,Emperor Announces Defeat,1945-08-15,,35.676,139.650,USA,combined,surrender,Emperor Hirohito announces Japan's surrender in radio broadcast; V-J Day celebrated,https://www.britannica.com/event/Surrender-of-Japan,#1F6FEB,flag,37. Emperor Announces Defeat (Aug 15 1945)
38,Surrender Signing,1945-09-02,,35.454,139.638,USA,combined,surrender,Formal Japanese surrender signed aboard USS Missouri in Tokyo Bay ends WWII,https://www.britannica.com/event/Surrender-of-Japan,#1F6FEB,flag,38. Surrender Signing (Sep 2 1945)`;

/* ---------- Helper functions ---------- */

function stripQuotes(s) {
  return (s || '').toString().replace(/^"|"$/g, '');
}

/**
 * Normalizes a longitude to the standard range of -180 to +180 degrees.
 * This prevents lines from wrapping across the entire map.
 * @param {number} lon The longitude to normalize.
 * @returns {number} The normalized longitude.
 */
function normalizeLongitude(lon) {
  return ((lon + 540) % 360) - 180;
}

/* Create a Leaflet icon object for specific symbols (emojis) */
function makeLdivIcon(html, className, size = 26) {
  return L.divIcon({
    html: `<div style="font-size: ${size}px; line-height: ${size}px;">${html}</div>`,
    className: className || 'custom-div-icon',
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2]
  });
}

/* Create a numbered circle marker with custom colors */
function createNumberedIcon(number, side = 'USA') {
  let markerClass = '';
  if (side.toLowerCase() === 'japan') markerClass = 'japan';
  else if (side.toLowerCase() === 'joint') markerClass = 'joint';
  
  return L.divIcon({
    html: `<div class="numbered-marker ${markerClass}" style="width: 26px; height: 26px;">${number}</div>`,
    className: 'custom-div-icon',
    iconSize: [26, 26],
    iconAnchor: [13, 13],
    popupAnchor: [0, -13]
  });
}

/* ---------- Load data and render map ---------- */
async function loadAndRenderMap() {
  const map = L.map('map', { 
    preferCanvas: true,
    minZoom: 2,
    maxZoom: 10
  }).setView([20, 150], 3); // Center on Pacific Ocean
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);

  // Create comprehensive legend
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <div class="legend-title">WWII Pacific Theater</div>
      <div class="legend-section">
        <div class="legend-section-title">Forces</div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#D0021B"></span>
          <span class="legend-text">Japanese offensive</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#1F6FEB"></span>
          <span class="legend-text">US/Allied offensive</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#7A3EE6"></span>
          <span class="legend-text">Joint operations</span>
        </div>
      </div>
      <div class="legend-section">
        <div class="legend-section-title">Special Events</div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#FF6B35;border-radius:3px;text-align:center;">&#x1F4A3;</span>
          <span class="legend-text">Major bombing</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#FF0000;border-radius:3px;text-align:center;">&#x2622;&#xFE0F;</span>
          <span class="legend-text">Atomic weapons</span>
        </div>
        <div class="legend-row">
          <span class="legend-swatch" style="background:#00AA00;border-radius:3px;text-align:center;">&#x1F3F3;&#xFE0F;</span>
          <span class="legend-text">Surrender/Flag raising</span>
        </div>
      </div>
      <div style="font-size:10px;color:#666;margin-top:8px;">
        Numbers indicate chronological order
      </div>
    `;
    return div;
  };
  legend.addTo(map);

  // Parse CSV data
  const parsed = Papa.parse(csvData, { header: true, skipEmptyLines: true });
  const rows = parsed.data || [];

  // Define icon mapping for keywords
  const specialIcons = {
    'bomb': makeLdivIcon('&#x1F4A3;', 'bomb-icon'), // Bomb emoji
    'atomic': makeLdivIcon('&#x2622;&#xFE0F;', 'atomic-icon'), // Radiation symbol
    'flag': makeLdivIcon('&#x1F3F3;&#xFE0F;', 'flag-icon') // White flag emoji
  };
  
  // Add markers with proper coordinate validation
  const markerLayer = L.featureGroup();
  let validMarkers = 0;
  
  rows.forEach((r, idx) => {
    const lat = parseFloat(r.lat);
    const lon = parseFloat(r.lon);
    
    // Validate coordinates
    if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90) {
      console.warn(`Skipping invalid marker: lat=${r.lat}, lon=${r.lon} for ${r.name}`);
      return;
    }

    const name = stripQuotes(r.name);
    const label = stripQuotes(r.label);
    const short_desc = stripQuotes(r.short_desc);
    const source = stripQuotes(r.source_url);
    const sideOffensive = stripQuotes(r.side_offensive);
    const markerSymbol = stripQuotes(r.marker_symbol);

    let marker = null;
    let icon = null;

    // Use specific icons for keywords
    if (markerSymbol in specialIcons) {
      icon = specialIcons[markerSymbol];
      marker = L.marker([lat, lon], { icon: icon });
    } else {
      // Create a numbered marker with the correct color
      icon = createNumberedIcon(markerSymbol, sideOffensive);
      marker = L.marker([lat, lon], { icon: icon });
    }
    
    // Create popup with rich content
    let popup = `<strong>${label || name}</strong>`;
    if (short_desc) popup += `<br>${short_desc}`;
    if (source) popup += `<br><a class="source" href="${source}" target="_blank" rel="noopener">Source</a>`;
    
    marker.addTo(markerLayer).bindPopup(popup, { maxWidth: 320, keepInView: true });
    validMarkers++;
  });

  markerLayer.addTo(map);

  // Add paths from the corrected GeoJSON object
  if (geoJsonData && geoJsonData.features) {
    L.geoJSON(geoJsonData, {
      style: f => {
        const p = f.properties || {};
        const s = p.style || {};
        return {
          color:
